<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Save Test</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-button {
            margin: 10px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .test-result {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h2>Transaction Save Test</h2>
        <p>This test verifies that the saveTransaction function works correctly with both FormData objects and regular objects.</p>
        <p><strong>Issue being tested:</strong> "formData.get is not a function" error when saving transactions</p>
        <p><strong>Expected behavior:</strong></p>
        <ul>
            <li>saveTransaction should work with FormData objects (using .get() methods)</li>
            <li>saveTransaction should work with regular objects (direct property access)</li>
            <li>saveTransaction should work with no parameters (collecting from DOM)</li>
        </ul>
    </div>

    <button class="test-button" onclick="testWithFormData()">Test with FormData Object</button>
    <button class="test-button" onclick="testWithRegularObject()">Test with Regular Object</button>
    <button class="test-button" onclick="testWithNullData()">Test with No Data (DOM Collection)</button>
    <button class="test-button" onclick="runAllTests()">Run All Tests</button>

    <div id="test-results"></div>
    <div id="test-log" class="test-log" style="display: none;"></div>

    <!-- Hidden transaction form for testing -->
    <div style="display: none;">
        <select id="transaction-part">
            <option value="1">Test Part (TP001) - Stock: 10</option>
        </select>
        <select id="transaction-type">
            <option value="OUT">Stock Out</option>
        </select>
        <input type="number" id="transaction-quantity" value="5">
        <input type="number" id="transaction-price" value="10.00">
        <input type="text" id="transaction-recipient" value="Test Recipient">
        <input type="text" id="transaction-reason" value="Test Reason">
        <input type="checkbox" id="transaction-is-paid">
        <input type="number" id="transaction-amount-paid" value="50.00">
        <textarea id="transaction-notes">Test notes</textarea>
    </div>

    <script type="module">
        // Mock the API and utilities
        const mockTransactionsAPI = {
            create: async (data) => {
                console.log('[DEBUG_LOG] Mock API called with data:', data);
                return { id: 1, ...data };
            }
        };

        const mockUtils = {
            showLoading: () => console.log('[DEBUG_LOG] showLoading called'),
            hideLoading: () => console.log('[DEBUG_LOG] hideLoading called'),
            showToast: (title, message, type = 'success') => console.log(`[DEBUG_LOG] Toast: ${title} - ${message} (${type})`),
            handleError: (error, context) => console.log(`[DEBUG_LOG] Error in ${context}:`, error)
        };

        // Mock the saveTransaction function (simplified version of the fixed function)
        async function saveTransaction(formData) {
            try {
                mockUtils.showLoading();
                
                // Handle both FormData objects and regular objects
                let transactionData;
                
                if (formData && typeof formData === 'object' && typeof formData.get === 'function') {
                    // FormData object - use .get() methods
                    transactionData = {
                        partId: parseInt(formData.get('transaction-part') || document.getElementById('transaction-part')?.value),
                        type: formData.get('transaction-type') || document.getElementById('transaction-type')?.value,
                        quantity: parseInt(formData.get('transaction-quantity') || document.getElementById('transaction-quantity')?.value),
                        unitPrice: parseFloat(formData.get('transaction-price') || document.getElementById('transaction-price')?.value) || null,
                        recipientName: formData.get('transaction-recipient') || document.getElementById('transaction-recipient')?.value || null,
                        reason: formData.get('transaction-reason') || document.getElementById('transaction-reason')?.value || null,
                        isPaid: formData.has('transaction-is-paid') || document.getElementById('transaction-is-paid')?.checked || false,
                        amountPaid: parseFloat(formData.get('transaction-amount-paid') || document.getElementById('transaction-amount-paid')?.value) || 0,
                        notes: formData.get('transaction-notes') || document.getElementById('transaction-notes')?.value || null
                    };
                } else if (formData && typeof formData === 'object') {
                    // Regular object - use it directly
                    transactionData = formData;
                } else {
                    // No data provided - collect from DOM elements
                    transactionData = {
                        partId: parseInt(document.getElementById('transaction-part')?.value),
                        type: document.getElementById('transaction-type')?.value,
                        quantity: parseInt(document.getElementById('transaction-quantity')?.value),
                        unitPrice: parseFloat(document.getElementById('transaction-price')?.value) || null,
                        recipientName: document.getElementById('transaction-recipient')?.value || null,
                        reason: document.getElementById('transaction-reason')?.value || null,
                        isPaid: document.getElementById('transaction-is-paid')?.checked || false,
                        amountPaid: parseFloat(document.getElementById('transaction-amount-paid')?.value) || 0,
                        notes: document.getElementById('transaction-notes')?.value || null
                    };
                }
                
                await mockTransactionsAPI.create(transactionData);
                mockUtils.showToast('Success', 'Transaction recorded successfully');
                
                return true;
            } catch (error) {
                mockUtils.handleError(error, 'saving transaction');
                return false;
            } finally {
                mockUtils.hideLoading();
            }
        }

        // Test functions
        window.testWithFormData = async function() {
            const log = document.getElementById('test-log');
            log.style.display = 'block';
            log.innerHTML = '';
            
            try {
                // Create FormData object
                const formData = new FormData();
                formData.append('transaction-part', '1');
                formData.append('transaction-type', 'OUT');
                formData.append('transaction-quantity', '3');
                formData.append('transaction-price', '15.00');
                formData.append('transaction-recipient', 'FormData Recipient');
                formData.append('transaction-reason', 'FormData Test');
                formData.append('transaction-amount-paid', '45.00');
                formData.append('transaction-notes', 'FormData test notes');
                
                console.log('[DEBUG_LOG] Testing with FormData object');
                const result = await saveTransaction(formData);
                
                showTestResult('FormData Test', result, 'FormData object test completed successfully');
            } catch (error) {
                showTestResult('FormData Test', false, `Error: ${error.message}`);
            }
        };

        window.testWithRegularObject = async function() {
            const log = document.getElementById('test-log');
            log.style.display = 'block';
            log.innerHTML = '';
            
            try {
                // Create regular object (like what modals.js sends)
                const transactionData = {
                    partId: 1,
                    type: 'OUT',
                    quantity: 2,
                    unitPrice: 20.00,
                    recipientName: 'Regular Object Recipient',
                    reason: 'Regular Object Test',
                    isPaid: false,
                    amountPaid: 40.00,
                    notes: 'Regular object test notes'
                };
                
                console.log('[DEBUG_LOG] Testing with regular object');
                const result = await saveTransaction(transactionData);
                
                showTestResult('Regular Object Test', result, 'Regular object test completed successfully');
            } catch (error) {
                showTestResult('Regular Object Test', false, `Error: ${error.message}`);
            }
        };

        window.testWithNullData = async function() {
            const log = document.getElementById('test-log');
            log.style.display = 'block';
            log.innerHTML = '';
            
            try {
                console.log('[DEBUG_LOG] Testing with null data (DOM collection)');
                const result = await saveTransaction(null);
                
                showTestResult('DOM Collection Test', result, 'DOM collection test completed successfully');
            } catch (error) {
                showTestResult('DOM Collection Test', false, `Error: ${error.message}`);
            }
        };

        window.runAllTests = async function() {
            const log = document.getElementById('test-log');
            log.style.display = 'block';
            log.innerHTML = '';
            
            console.log('[DEBUG_LOG] Running all tests...');
            
            await testWithFormData();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testWithRegularObject();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testWithNullData();
            
            console.log('[DEBUG_LOG] All tests completed');
        };

        function showTestResult(testName, success, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultClass = success ? 'success' : 'error';
            const resultIcon = success ? '✓' : '✗';
            
            const resultHTML = `
                <div class="test-result ${resultClass}">
                    <h3>${resultIcon} ${testName}</h3>
                    <p>${message}</p>
                </div>
            `;
            
            resultsDiv.innerHTML += resultHTML;
        }

        // Capture console logs
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logDiv = document.getElementById('test-log');
            if (logDiv && args[0] && args[0].includes('[DEBUG_LOG]')) {
                logDiv.innerHTML += args.join(' ') + '\n';
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        };
    </script>
</body>
</html>