<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Duplicate Parts and Refresh Functionality</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .toast.show {
            opacity: 1;
        }
        .toast.success {
            background-color: #28a745;
        }
        .toast.error {
            background-color: #dc3545;
        }
        .toast.warning {
            background-color: #ffc107;
            color: black;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-flask"></i> Test Duplicate Parts and Refresh Functionality</h1>

        <!-- Test 1: Duplicate Part Creation -->
        <div class="test-section">
            <h3><i class="fas fa-exclamation-triangle"></i> Test 1: Duplicate Part Detection</h3>
            <p>This test will create a part and then try to create another part with the same name or part number to test duplicate detection.</p>

            <div class="test-form">
                <div class="form-group">
                    <label for="test-part-name">Part Name:</label>
                    <input type="text" id="test-part-name" value="Test Brake Pad" placeholder="Enter part name">
                </div>
                <div class="form-group">
                    <label for="test-part-number">Part Number:</label>
                    <input type="text" id="test-part-number" value="BP-001-TEST" placeholder="Enter part number">
                </div>
                <div class="form-group">
                    <label for="test-part-price">Unit Price:</label>
                    <input type="number" id="test-part-price" value="25.99" step="0.01" placeholder="Enter price">
                </div>
                <div class="form-group">
                    <label for="test-part-stock">Initial Stock:</label>
                    <input type="number" id="test-part-stock" value="10" placeholder="Enter stock">
                </div>
                <div class="form-group">
                    <label for="test-part-min-stock">Minimum Stock:</label>
                    <input type="number" id="test-part-min-stock" value="5" placeholder="Enter minimum stock">
                </div>
            </div>

            <button class="btn btn-primary" onclick="createTestPart()">
                <i class="fas fa-plus"></i> Create Test Part
            </button>
            <button class="btn btn-warning" onclick="createDuplicatePart()">
                <i class="fas fa-copy"></i> Try Create Duplicate
            </button>

            <div id="test1-results" class="test-results" style="display: none;">
                <h4>Test Results:</h4>
                <div id="test1-output"></div>
            </div>
        </div>

        <!-- Test 2: Transaction and Parts Refresh -->
        <div class="test-section">
            <h3><i class="fas fa-sync-alt"></i> Test 2: Parts Refresh After Transaction</h3>
            <p>This test will create a transaction and verify that parts data is refreshed to show updated stock levels.</p>

            <div class="test-form">
                <div class="form-group">
                    <label for="transaction-type">Transaction Type:</label>
                    <select id="transaction-type">
                        <option value="IN">Stock In</option>
                        <option value="OUT">Stock Out</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transaction-quantity">Quantity:</label>
                    <input type="number" id="transaction-quantity" value="5" placeholder="Enter quantity">
                </div>
                <div class="form-group">
                    <label for="transaction-recipient">Recipient (for OUT transactions):</label>
                    <input type="text" id="transaction-recipient" value="Test Customer" placeholder="Enter recipient name">
                </div>
            </div>

            <button class="btn btn-success" onclick="createTestTransaction()">
                <i class="fas fa-exchange-alt"></i> Create Test Transaction
            </button>
            <button class="btn btn-primary" onclick="checkPartsRefresh()">
                <i class="fas fa-search"></i> Check Parts Refresh
            </button>

            <div id="test2-results" class="test-results" style="display: none;">
                <h4>Test Results:</h4>
                <div id="test2-output"></div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container"></div>

    <script type="module">
        import { partsAPI, transactionsAPI, categoriesAPI } from './js/api.js';
        import { showToast } from './js/ui-utils.js';
        import { savePart } from './js/parts.js';
        import { saveTransaction } from './js/transactions.js';

        let testPartId = null;
        let initialStock = 0;

        // Show loading
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Show toast message
        function showTestToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} show`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Create test part
        window.createTestPart = async function() {
            try {
                showLoading();

                // Get categories first
                const categories = await categoriesAPI.getAll();
                if (categories.length === 0) {
                    throw new Error('No categories found. Please create a category first.');
                }

                const partData = {
                    name: document.getElementById('test-part-name').value,
                    partNumber: document.getElementById('test-part-number').value,
                    categoryId: categories[0].id,
                    unitPrice: parseFloat(document.getElementById('test-part-price').value),
                    initialStock: parseInt(document.getElementById('test-part-stock').value),
                    minimumStock: parseInt(document.getElementById('test-part-min-stock').value),
                    description: 'Test part for duplicate detection'
                };

                const result = await partsAPI.create(partData);
                testPartId = result.id;
                initialStock = result.currentStock;

                document.getElementById('test1-results').style.display = 'block';
                document.getElementById('test1-output').innerHTML = `
                    <div style="color: green;">
                        <i class="fas fa-check"></i> Test part created successfully!<br>
                        <strong>Part ID:</strong> ${result.id}<br>
                        <strong>Name:</strong> ${result.name}<br>
                        <strong>Part Number:</strong> ${result.partNumber}<br>
                        <strong>Stock:</strong> ${result.currentStock}
                    </div>
                `;

                showTestToast('Test part created successfully!', 'success');

            } catch (error) {
                document.getElementById('test1-results').style.display = 'block';
                document.getElementById('test1-output').innerHTML = `
                    <div style="color: red;">
                        <i class="fas fa-times"></i> Error creating test part: ${error.message}
                    </div>
                `;
                showTestToast('Error creating test part: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        };

        // Try to create duplicate part
        window.createDuplicatePart = async function() {
            if (!testPartId) {
                showTestToast('Please create a test part first!', 'warning');
                return;
            }

            try {
                showLoading();

                const categories = await categoriesAPI.getAll();
                const partData = {
                    name: document.getElementById('test-part-name').value, // Same name
                    partNumber: document.getElementById('test-part-number').value, // Same part number
                    categoryId: categories[0].id,
                    unitPrice: parseFloat(document.getElementById('test-part-price').value),
                    initialStock: parseInt(document.getElementById('test-part-stock').value),
                    minimumStock: parseInt(document.getElementById('test-part-min-stock').value),
                    description: 'Duplicate test part'
                };

                // This should trigger the duplicate warning using savePart function
                const success = await savePart(partData, false);

                if (success) {
                    document.getElementById('test1-output').innerHTML += `
                        <div style="color: orange; margin-top: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> Duplicate part was created (user may have chosen to proceed)<br>
                            <em>This indicates the duplicate warning was shown and user chose to continue.</em>
                        </div>
                    `;
                } else {
                    document.getElementById('test1-output').innerHTML += `
                        <div style="color: green; margin-top: 10px;">
                            <i class="fas fa-check"></i> Duplicate detection working correctly!<br>
                            <em>Part creation was cancelled due to duplicates.</em>
                        </div>
                    `;
                }

            } catch (error) {
                document.getElementById('test1-output').innerHTML += `
                    <div style="color: red; margin-top: 10px;">
                        <i class="fas fa-times"></i> Error creating duplicate part: ${error.message}<br>
                        <em>This is expected if duplicate checking is working properly.</em>
                    </div>
                `;
                showTestToast('Duplicate detection working: ' + error.message, 'warning');
            } finally {
                hideLoading();
            }
        };

        // Create test transaction
        window.createTestTransaction = async function() {
            if (!testPartId) {
                showTestToast('Please create a test part first!', 'warning');
                return;
            }

            try {
                showLoading();

                const transactionData = {
                    partId: testPartId,
                    type: document.getElementById('transaction-type').value,
                    quantity: parseInt(document.getElementById('transaction-quantity').value),
                    recipientName: document.getElementById('transaction-recipient').value,
                    reason: 'Test transaction for refresh functionality',
                    isPaid: true,
                    amountPaid: 0
                };

                const success = await saveTransaction(transactionData);

                document.getElementById('test2-results').style.display = 'block';
                if (success) {
                    document.getElementById('test2-output').innerHTML = `
                        <div style="color: green;">
                            <i class="fas fa-check"></i> Test transaction created successfully!<br>
                            <strong>Type:</strong> ${transactionData.type}<br>
                            <strong>Quantity:</strong> ${transactionData.quantity}<br>
                            <strong>Part ID:</strong> ${transactionData.partId}<br>
                            <em>Parts refresh should have been triggered automatically.</em>
                        </div>
                    `;
                    showTestToast('Test transaction created successfully!', 'success');
                } else {
                    document.getElementById('test2-output').innerHTML = `
                        <div style="color: red;">
                            <i class="fas fa-times"></i> Failed to create test transaction!
                        </div>
                    `;
                    showTestToast('Failed to create test transaction!', 'error');
                }

                // Wait a moment then check if parts were refreshed
                setTimeout(checkPartsRefresh, 1000);

            } catch (error) {
                document.getElementById('test2-results').style.display = 'block';
                document.getElementById('test2-output').innerHTML = `
                    <div style="color: red;">
                        <i class="fas fa-times"></i> Error creating test transaction: ${error.message}
                    </div>
                `;
                showTestToast('Error creating test transaction: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        };

        // Check if parts were refreshed
        window.checkPartsRefresh = async function() {
            if (!testPartId) {
                showTestToast('Please create a test part first!', 'warning');
                return;
            }

            try {
                showLoading();

                const part = await partsAPI.getById(testPartId);
                const stockChanged = part.currentStock !== initialStock;

                document.getElementById('test2-output').innerHTML += `
                    <div style="color: ${stockChanged ? 'green' : 'orange'}; margin-top: 10px;">
                        <i class="fas fa-${stockChanged ? 'check' : 'exclamation-triangle'}"></i> 
                        Parts refresh test: ${stockChanged ? 'PASSED' : 'NEEDS VERIFICATION'}<br>
                        <strong>Initial Stock:</strong> ${initialStock}<br>
                        <strong>Current Stock:</strong> ${part.currentStock}<br>
                        <strong>Stock Changed:</strong> ${stockChanged ? 'Yes' : 'No'}
                    </div>
                `;

                if (stockChanged) {
                    showTestToast('Parts refresh test PASSED!', 'success');
                } else {
                    showTestToast('Parts refresh needs verification - check if transaction was processed', 'warning');
                }

            } catch (error) {
                document.getElementById('test2-output').innerHTML += `
                    <div style="color: red; margin-top: 10px;">
                        <i class="fas fa-times"></i> Error checking parts refresh: ${error.message}
                    </div>
                `;
                showTestToast('Error checking parts refresh: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        };
    </script>
</body>
</html>
